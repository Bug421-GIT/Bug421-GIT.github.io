---
title: 6.网络层
author: Ana-Ana
date: 2022-06-18
tags: [computerNetwork]
categories: ["计算机网络"]
render_with_liquid: true
layout: post
---
<!-- ## 应用层 -->

​	网络体系结构的最顶层，享受下层提供的服务，无视下层具体操作活动；

​	通过应用进程的交互，实现特定网络应用的问题；

​	是设计和建立计算机网络的最终目的

### C/S 和 P2P

#### C/S

客户 / 服务器（Client/Server）

- 客户：是计算机、是进程，是服务请求方
- 服务器：
  - 是计算机、是进程，是服务提供方
  - 总是处于运行状态，等待客户请求
  - 具有固定的端口号，主机有固定的IP地址
- 服务集中型
  - 应用服务集中 比客户端少得多的 服务器上
  - 常会出现服务器跟不上客户端请求的情况
  - 计算机群集（服务器场）构建一个强大的虚拟服务器

#### P2P

对等方式 （ Peer - to - Peer）

- 没有固定的请求者和提供者，应用进程对等、直接通信
- 服务分散型
  - 大量对等计算机都是服务的提供和请求者
  - 可扩展性：不会因为规模扩大而减低系统性能
- 用户越多，速度越快；成本优势

### DHCP

​	动态主机配置协议，又称为即插即用网络。

​	允许一台计算机加入新网络时，可以自动获取IP地址等网络配置信息而不用手工配置。

​	TCP/IP的应用层协议，使用UDP传输

​	DHCP	服务器的端口67；客户端的端口68

#### 工作过程

1. **discover ** *寻找服务器* 

   客户端 发送UDP用户数据报，包含DHCP发现报文；

   1. 目的地址`255.255.255.255`：不知道当前网络中有多少个DHCP服务端，和他们具体的IP
   2. 源地址`0.0.0.0`：当前主机未分配到IP地址
   3. 目的端口号`67`：非DHCP服务器不监视该端口，收到但丢弃；仅DHCP服务器作出回复
   4. 数据域封装有 事务ID + DHCP客户端的MAC地址

2. **Offer** *提供一套方案*

   DHCP服务器收到该报文，

   1. 拆分、查找是否有针对其MAC地址的配置信息
      - 有：将该配置信息封装 → DHCP提供报文
      - 无：默认配置信息封装 → DHCP提供报文
   2. 封装回复报文
      - 目的地址：`255.255.255.255`，目标设备未分配到IP地址
      - 源地址：DHCP服务器地址
      - 目的端口号`68`：非DHCP客户端不监视该接口，收到但丢弃；仅DHCP客户端作出回复

3. **Request** *确认选择某一套方案*

   客户端收到回复：

   1. 根据报文中的`事务ID`判断是否是自己所请求的报文
   2. 配置信息包括：IP地址（使用<u>ARP检测</u>确保该IP未被网络中的其他主机占用）、子网掩码、地址租期、默认网关、DNS服务器
   3. 挑选一个（先到的）报文作为自己的DHCP，发送 DHCP请求报文征求其同意：
      - 目的地址`255.255.255.255`：告知所有的DHCP，我挑选到它啦
      - 源地址`0.0.0.0`：现在未获得DHCP服务器的同意
      - 报文内容：事务ID、DHCP客户端的MAC地址、接受租约的IP地址、提供租约的DHCP服务端IP地址等 

4. **ACK** *最终确认*

   服务端回复是否同意租约

   1. 目的地址：`255.255.255.255`
   2. 源地址：DHCP服务器

5. 客户端收到确认后，使用<u>ARP检测</u>所分配的IP地址是否被网络其他主机占用

   1. 若未被占用，客户端可以开始使用该IP地址
   2. 若被占用，
      1. 给DHCP服务器发送 **DHCP decline**报文撤销IP地址租约
      2. 重发 **DHCP discover**报文寻找方案

6. **续约** 当租期过半时

   1. 客户端请求续约 **DHCP request**

      - 源地址：租用的地址
      - 目的地址：DHCP服务器
   2. 服务器不同的反应
      1. 若同意续约 **DHCP ACK**，得到新的租期
      2. 若不同意续约 **DHCP NACK**，客户端必须立即停用租用的IP地址并重新发送 **DHCP discover**
      3. 若不响应，客户端等待一段时间
   3. 等待到0.875 = 7/8的租期时间，客户端必须重新发送 续约 **DHCP request**
   4. 等待到租期结束，客户端必须停用租用的IP地址并重新发送 **DHCP discover**

7. **解约** 客户端可以随时放弃租用的IP地址，向提供DHCP服务器发送 **DHCP release**释放报文即可

#### 中继代理

​	某个网络拓扑中没有DHCP服务器，其客户端法发送的 DHCP discover请求使用广播地址`255.255.255.255`不能经过普通路由器转发而是丢弃，内部又没有可以相应其DHCP请求的服务，导致该网络拓扑中的主机无法自动获取网络配置信息。

​	解决办法，为该路由器配置DHCP服务器的IP地址使之成为 **DHCP中继代理**

​	路由器收到广播的DHCP discover报文后，会单播转发给其他网络拓扑中存在的DHCP服务器，此后都如此交互

​	使每个网络不必都配置DHCP服务器，至少有一个即可

### DNS  

​	域名系统（Domain Name System），将域名翻译为IP地址寻址

​	每台用户主机都需要经过DNS查找域名对应的IP地址，故DNS服务器不能只有一台，它应该在本地解析或一个分布式服务器集群

​	因特网使用层次结构命名树 + 分布式域名系统，大多数域名在本地解析

#### 域名空间

​	1. 各级域名：由若干个分量，以`.`隔开，分别代表不同级别的域名

​		每一级域名（< 63个字符）有 英文（不区分大小写） + 数字 ，完整域名 < 255个字符

​		`···.三级域名.二级域名.顶级域名` 右边大，各级域名由其上级机构管理；顶级域名由因特网名称与数字分配机构ICMN管理

2. 顶级域名TLD（Top Level Domain）分为三类
   1. 国家顶级域名nTLD：ISO 3166规定
   2. 通用顶级域名gTLD：常见七个（`com`公司企业、`net`网络服务机构、`org`非营利性组织、`int`国际组织、`edu`美国教育机构、`gov`美国政府部门、`mil`美国军事部门）
   3. 反向域名arpa：用以反向域名解析，即IP地址 → 域名
3. 二级域名
   1. 由国家自行规定
   2. 分为两类
      1. 类别域名：七个（`ac`科研机构、`com`工商金融等企业、`edu`教育机构、`gov`政府部门、`net`提供网络服务机构、`mil`军事机构、`org`非盈利组织）
      2. 行政区域名：34个，分配给各省、自治区、直辖市
4. 便于维护名字的唯一性，易查询；逻辑概念，而非物理地点

#### 域名服务器

​	分布式实现

1. 根 域名服务器
   - 分布式构成的13个根域名服务器，是高层的域名服务器
   - 不直接对域名解析，而是提供该域名所在的 顶级服务器IP地址
2. 顶级 域名服务器
   - 管理该顶级域名下的 二级域名
   - 返回下一级权限服务器的IP地址
3. 权限 域名服务器
   - 管理某个区的域名，主机必须所管辖服务器注册登记
   - 管辖的域名与IP地址的映射关系；下级服务器的地址
4. 本地 域名服务器
   - 主机第一个经过的域名服务器，起着代管作用，对其转发
   - 距离主机距离较近，一般四五个路由器

#### 域名解析

##### 解析过程

- 递归查询

   直接一级一级向下查询，本地 -- 根 -- 顶级 -- 权限，获得结果就往回传递

- 迭代查询

   每向一节查询，拿着结果，向另一级查询。

   本地 -- 跟 = 顶级IP；本地 -- 顶级IP = 权限IP；本地 -- 权限 = 目标IP；本地服务器将目标IP交给主机

递归查询对被查询的域名服务器负载要求大，所以采用两者相结合：

1. 主机 -- 本地：递归查询
2. 本地 -- 其余服务器：迭代查询

##### 解析原理（？）

DNS指针查询（反向查找、逆向解析）的基本原理

#### DNS缓存

​	为提高查询效率，减少查询报文数量，减轻服务器负荷

​	域名服务器广泛使用 **高速缓存**，存放最近查询过的域名、何处获取的域名映射信息记录

​	本地主机也需要维护好 域名：IP地址数据库

​	缓存为每项内容设置计时器，并删除超过合理时间的项

### FTP

​	文件传输协议（File Transfer Protocol）

- 交互式访问，允许指明文件类型与格式、文件存取权限（授权、口令）
- 屏蔽计算机系统细节，适用于异构网络中任意计算机之间

#### 基本工作原理

两种不同的传输模式

主动模式

- 服务器监听 熟知端口号`21`，等待客户发起FTP连接

- **控制连接**：建立TCP连接，用于**传送FTP相关控制命令**，即`命令通道`

- 如果有数据传输，客户端通过`命令通道`告知服务器：需要开放另一条TCP连接，作为`数据通道`

- **数据连接**：服务器开放 <u>熟知端口号`20`</u>，向客户发起FTP连接（主动模式），用于**传输FTP文件**

  

被动模式

- **控制连接**一样
- 如果有数据传输，客户端通过`命令通道`告知服务器：需要开放另一条TCP连接，作为`数据通道`
- **数据连接**：服务器开启 <u>临时端口</u>（双方协商好的端口号），被动等待客户连接（被动模式），建立数据通道



两个TCP连接并行：

​	控制连接需要在绘话期间一直保持打开；

​	数据连接在每次文件传输时建立，结束时结束

客户端的接口都是随机的

#### ？

1. 控制连接 + 数据连接（为什要？
2. 两种工作模式：PASV + PORT
3. 指令和响应码

3. 断电续传 + 匿名FTP

### 万维网WWW

​	world wide web，运行在Internet中的分布式应用，而非某种特殊的计算机网络

​	利用超链接，将不同网站的网页连接

**统一资源定位符URL**：`<协议>://<主机>:<端口>/<路径>`

**连接方式两种**：

- 非持续连接
  - HTTP / 1.0
  - 每次请求就建立TCP连接，收到响应后立即关闭连接
  - 请求一个WWW文档时间 = 2RTT + 文档传送时延
  - 为减少时延，通常会建立多个并行TCP同时请求多个对象；但占用服务器资源
- 持续连接
  - HTTP / 1.1
  - 同一个浏览器与该服务器的TCP连接可以继续传送请求和响应
  - 流水线模式：收到响应之前连续发送多个请求，而后服务器一个接一个响应
  - 非流水线模式：只有上一个请求被响应后才可以发送下一个请求

#### HTTP

#### 报文格式

HTTP是 **面向文本**，报文的每一个字段都是一些ASCII码率，且长度不确定

###### 请求格式（+各种字段）

![HTTP请求报文格式](../assets/img/计算机网络.assets/HTTP请求报文格式.png){: width="972" height="589" .w-75 .normal}

- 请求行
  - 指明方法：GET POST PUT 
  - 资源地址：URL
  - HTTP 版本

- 首部行
  - Connect：close — 告诉服务器发送完请求文档后可释放连接
  - User-Agent：Mozilla/5.0 — 告诉服务器 浏览器使用的类型和版本
  - Accept-Language：cn — 告诉服务器 用户希望优先得到中文版本的文档

| 方法    | 描述                                  |
| ------- | ------------------------------------- |
| HEAD    | 请求URL标志的文档首部                 |
| CONNECT | 用于代理服务器                        |
| OPTIONS | 请求一些选项信息                      |
| TRACE   | 用来进行环回测试                      |
|         |                                       |
| GET     | 请求URL标志的文档                     |
| POST    | 向服务器发送数据                      |
| PUT     | 在指明的URL下存档一个文档             |
| DELETE  | 删除URL标志的文档                     |
| PATCH   | 对PUT方法补充，对已知资源进行局部更新 |

###### 响应（+各种字段）

![HTTP响应报文格式](../assets/img/计算机网络.assets/HTTP响应报文格式.png){: width="972" height="589" .w-75 .normal}

| 状态码 | （五大类，33种）描述                               |
| ------ | -------------------------------------------------- |
| 1XX    | 表示通知信息，如：请求收到了、正在进行处理         |
| 2XX    | 表示成功，如：接受了、知道了                       |
| 3XX    | 表示重定向，即要完成请求还必须采取进一步的行动     |
| 4XX    | 表示客户的差错，如：请求中有错误的语法、或不能完成 |
| 5XX    | 表示服务器的差错，如：服务器失效无法完成请求       |

#### Cookie

​	HTTP为无状态协议，使用Cookie对其进行状态化的技术

1. 双方建立TCP连接成功时，服务器为用户生成唯一的cookie识别码Set-Cookie
2. 用户端将Cookie信息存放到文档
3. 每次用户端发送请求，读取Cookie码并将其携带上
4. 服务器根据Cookie码识别用户，并返回个性化页面

### HTTPS（？

1. 详细握手过程
2. 摘要算法、数字签名、数字证书的原理和过程

### 电子邮件

​	电子邮件系统上采用 客户/服务器方式，有三个部件构成：用户代理，邮件服务器，电子邮件所需的协议

- 用户代理：用户与电子邮件系统的接口，又称 电子邮件客户端软件
- 邮件服务器：
  - 电子邮件系统的基础设施，Internet所有的ISP（Internet Service Provider，互联网服务提供商）都有邮件服务器
  - 其功能是发送和接受邮件，维护用户的邮箱
- 协议：邮件发送协议（SMTP）+邮件读取协议（POP3，IMAP）

#### 邮件协议的使用范围

![邮件协议的使用范围](../assets/img/计算机网络.assets/邮件协议的使用范围.jpg){: width="972" height="589" .w-75 .normal}

#### SMTP 

##### SMTP 与 MIME

1. SMTP协议
   1. 只能传送ASCII码文本数据，不能传送可执行文件或其他的二进制对象。
   2. 不能满足传送多媒体邮件（例如带有图片、音频或视频数据）的需要。
   3. 许多其他非英语国家的文字（例如中文、俄文、甚至带有重音符号的法文或德文）也无法用SMTP传送。
2. MIME（多用途因特网邮件扩展，Multipurpose Internet Mail Extensions）
   1. 为解决SMTP传送非ASCII码文本的问题，
   2. 增加了5个新的邮件首部字段，这些字段提供了有关邮件主体的信息。
   3. 定义了许多邮件内容的格式，对多媒体电子邮件的表示方法进行了标准化。
   4. 定义了传送编码，可对任何内容格式进行转换，而不会被邮件系统改变。

实际上，MIME不仅仅用于SMTP，也用于后来的同样面向ASCII字符的HTTP

##### 基本工作原理

![STMP的基本工作原理](../assets/img/计算机网络.assets/STMP的基本工作原理.png){: width="972" height="589" .w-75 .normal}

#### 信息格式

![电子邮件的信息格式](../assets/img/计算机网络.assets/电子邮件的信息格式.png){: width="972" height="589" .w-75 .normal}

#### 邮件读取协议

​	都使用基于TCP连接的客户/服务器方式

##### POP 邮局协议

​	Post Office Protacol，是Internet的正式标准。

- 非常简单，功能有限
- 用户只能 下载+删除、下载+保留的方式 获取邮件到计算机
- 不允许用户在邮件服务器上管理自己的邮件
- 熟知端口110

##### IMAP Internet邮件访问协议

​	Internet Message Access Protocol，是Internet的建议标准

- 功能强大，是一个联机协议
- 用户可以在计算机上操作邮件服务器的邮箱
- 熟知端口143

#### 基于万维网的电子邮件

​	通过浏览器 → 邮件服务器万维网，撰写、收发、阅读和管理；无需安装软件



TCP 区分应用进程；实现可靠传输

添加ETH 使之成为（以太网）帧

 

 

帧：目的地址 + 源地址 + 类型 + 包 + 4字节校验码

前导码：1字节帧开始界定符 + 7字节前同步码 让目的主机做好接受帧的准备
