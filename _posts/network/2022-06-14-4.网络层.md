---
title: 4. 网络层
author: Ana-Ana
date: 2022-06-14 
tags: [computerNetwork]
categories: ["计算机网络"]
render_with_liquid: true
layout: post
toc: true
---

<!-- ## 网络层 -->

​	实现网络互连，数据包在其之间的传输

- 向上层（运输层）提供怎样的服务？IP提供的是 <u>面向无连接，不可靠服务</u>

- 网络寻址问题：A类地址、B类地址、C类地址

- 路由选择问题：路由表 + 目的地址

  - 路由表的数据来源：人工设置（小型，不改变）、路由选择协议中的选择算法 

  因特网，使用TCP/IP协议，网络层使用**网际协议IP**，由此TCP/IP中的网络层又称为**网际层**

### 提供的两种连接

1. 面向连接的虚电路

   1. 可靠通信由**网络**来保障
   2. 建立网络层的连接——虚电路CV，沿着此电路发送分组
   3. 目的主机地址仅在建立初阶段使用，之后 <u>首部只携带虚电路的编号</u>
   4. 通信结束后，需要释放所建立的虚电路

   虚电路 + 可靠传输协议 = 无传输差错

   - 虚电路是一条逻辑上的电路，事实上不存在
   - 电话交换的电话通信，是建立一条物理上的电路

2. 无连接的数据报服务

   1. 可靠通信由**用户主机**来保障
   2. 不建立网络层练级——每个分组可走不同的路径
   3. 目的主机的完整地址需要时刻携带
   4. 可能出现传输差错，但造价低廉，适应性强

   将复杂网络处理功能至于因特网边缘（用户主机和其内部的运输层）

## IPv4

​	每一台主机（或路由器）的每个接口，分配唯一的32bit的识别符

​	点分十进制表示法，每8位分为一组

### 分类编址方式

1. A类地址：8位（网络号）+ 24位（主机号）
   1. 网络号第一个比特值一定为`0`
   2. 最小网络号0，保留不指派
      1. 0.0.0.0是一个特殊的网络地址，表示“在本网络上的本主机”，只能作为源地址使用
   3. 最大网络号127，作为本地环回测试地址，不指派
      1. 最小的：127.0.0.1
      2. 最大的：127.255.255.254
   4. 可指派的网络地址1.0.0.0 - 126.0.0.0
2. B类地址：16位（网络号）+ 16位（主机号）
   1. 网络号第一二个比特值一定为`10`
   2. 最小网络号，也是第一个可指派的网络号 128.0
   3. 最大网络号，也是最后一个可指派的网络号 129.255
   4. 可指派的网络地址：128.0.0.0 - 191.255.0.0
3. C类地址：24位（网络号）+ 8位（主机号）
   1. 网络号第一二三个比特值一定为`110`
   2. 最小的网络号，也是第一个可指派的网络号 192.0.0
   3. 最大的网络号，也是最后一个可指派的网络号 223.255.255
   4. 可指派的网络地址：192.0.0.0 - 223.255.255.0
4. D类地址：多播地址
5. E类地址：保留今后使用
6. 广播地址：255.255.255.255，表示“只在本网络进行广播”，只能作为目的地址使用

### 子网划分

1. 为什么要划分子网：

   1. 申请更多的IP地址，会导致路由表记录数量怎多
   2. 浪费原有网络中剩余的IP地址

2. 子网地址计算

   【例题】网络地址为218.75.230.0，使用子网掩码255.255.255.128对其子网划分。

   1. 218.75.230.0：该网络为C类网络地址，前三个值为网络号，最后一位是主机号

   2. 255.255.255.128：

      1. 前三个255表示连续24个比特1，对应了网络号部分，
   2. 128化为二进制表示一个比特1，即从主机号中借用了一个比特作为子网号
   
3. 划分的子网数量 2^1 = 2，每个子网可分配的地址数量2^（8-1 ) - 2=126 
   
      [去掉主机号全为`0`的网络地址、全为`1`的广播地址]

3. 默认子网

   在未划分子网的情况下使用子网掩码

   网络号对应掩码全为`1`，主机号的对应掩码全为`0`

## 报文

### 首部格式

![IP数据报首部格式](../assets/img/计算机网络.assets/IP数据报首部格式.png){: width="972" height="589" .w-75 .normal}

首部长度：4个字节

- 最大值为15：固定部分 20字节 + 可变部分 40字节
- 最小值为10：固定部分 20字节
- IP数据报的首部长度一定是4的整数倍

- 区分服务
  - 8bit，一般不使用
  - 该字段的不同数值可提供不同等级的服务质量
  
- 总长度
  
  - 首部长度 + 数据载荷
  
- 【标识 + 标志 + 片偏移：IP数据报分片】

- 生存时间：防止数据报在网络中兜圈 -- 路由环路

  - 以“时间”为计数，初始 - 当前路由花费的时间 = 剩余时间
    - ＞0，转发；≤ 0，丢弃
  - 以“跳数”为计数，跳转指定次数
    - ＞0，转发；≤ 0，丢弃

- 协议

  - 8bit，数据部分是何种协议数据单元

  - 常用协议与字段值

	  ![常用协议与字段值](../assets/img/计算机网络.assets/\常用协议与字段值.png){: width="972" height="589" .w-75 .normal}

- 首部检验和
  - 16bit，检验首部在传输过程是否出现差错
  - IP层本身不提供可靠传输服务，因而IPv6将不再进行校验
- 源IP地址和目的IP地址，各占32bit

### 分片方式

1. 为什么要分片：
   1. IP数据报需要打包成帧，而帧长度受限于的最大传输单位MTU
   2. 当IP数据报长度 > 帧，需要 **分片** 成更小的数据报文
2. 标识：
   1. 16bit
   2. 同一个数据报的各分片应该具有相同的标识
   3. IP软件维持一个计数器，每产生一个数据报计数器+1，赋值给标识字段
3. 标志
   - 3bit
   - DF位：（Don't 分片？）
      - 1 -- 不允许分片
      - 0 -- 允许分片
   - MF为：（More 分片?）
      - 1 -- 后面还有分片
      - 0 -- 这是最后一个分片
   - 保留位，必须设置为0
4. 片偏移
   1. 13bit
   2. 分片数据报的数据载荷部分 在原数据报位置 偏移多少个位置
   3. 以8个字节为单位 -- 数据载荷的第n个字符 / 8 （再次分片，第n遵循最初的位置）

### 选路？

## ICMP

​	为提高IP数据报 **转发和交付成功的概率**，在网际层使用网际控制报文协议Internet control message protocol

​	被封装在IP数据报中发送

​	应用场景：

1. 分组网间探测PING
   - 测试主机间的连通性
   - 应用层直接使用网际层的ICMP（而不ton过运输层的TCP和UDP）
   - 使用ICMP的回送请求和回答请求
2. 跟踪路由
   - 测试IP数据报经过哪些路由传递
   - Windows系统
     - tracect命令
     - 应用层直接只用网际层ICMP
     - ICMP回送请求、回答报文、差错报文
   - Unix版本
     - traceroute命令
     - 在运输层使用UDP协议
     - 只使用了差错报文

### 查询报文2种

1. **回送请求和回答**：
   1. 请求报文：向特定主机发出询问
   2. 回答报文：收到请求的主机必须回复
   3. 测试目的站是否可达+状态
2. **时间戳请求和回答**
   1. 请主机回答当前的日期和时间
   2. 时钟同步和测量时间

### 差错报文5种

1. **终点不可达**：目的主机、路由不能交付数据报
2. **源点抑制**：目的拥塞而丢弃报文，通知源点数据发送速率放慢
3. **时间超过**：
   1. 路由因TTL < 0而丢弃报文时，要通知源点
   2. 规定时间内没有收到一个报文的全部报片，会将已收到的全部丢弃，并通知源点
4. **参数问题**：首部检验与字段发现传输中出现误码，丢弃且通知源点
5. **改变路由（重定向）**：路由路径有更优解时

**不可发送差错报文的情况：**

   1. 对<u>ICMP差错报文</u> 不再发送 差错报文
      2. 对<u>第一个分片的数据报片的所有后续数据报片</u> 都不再发送差错报文
      3. 对<u>具有多播地址的数据报</u> 都不发送ICMP差错报文
      4. 对<u>特殊地址的数据报</u> 不发送差错报文

## ARP？
