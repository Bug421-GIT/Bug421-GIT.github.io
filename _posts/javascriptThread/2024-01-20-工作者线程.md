---
title: å·¥ä½œè€…çº¿ç¨‹
author: "Ana-Ana"
date: 2024-01-20
tags: ["javascriptThread","Thread"]
categories: ["javascriptThread"]
render_with_liquid: true
layout: post
pin: true
---
# å·¥ä½œè€…çº¿ç¨‹

â€‹	å…è®¸æŠŠä¸»çº¿ç¨‹çš„å·¥ä½œè½¬ç§»åˆ°ç‹¬ç«‹çš„å®ä½“ï¼Œè€Œä¸æ”¹å˜ç°æœ‰çš„å•çº¿ç¨‹æ¨¡å¼ã€‚æµè§ˆå™¨ä¸»çº¿ç¨‹è´Ÿè´£ä¸å¤„ç†ç”¨æˆ·äº‹ä»¶å’Œé¡µé¢ç»˜åˆ¶ç­‰ã€‚

â€‹	JavaScriptç¯å¢ƒå®é™…æ˜¯è¿è¡Œåœ¨æ‰˜ç®¡æ“ä½œç³»ç»Ÿçš„è™šæ‹Ÿç¯å¢ƒã€‚æ¯ä¸ªé¡µé¢éƒ½æœ‰è‡ªå·±çš„ç¯å¢ƒï¼Œå†…å­˜ã€äº‹ä»¶å¾ªç¯ã€DOMç­‰ç­‰ï¼Œä¸ä¼šå½±å“åˆ°å…¶ä»–é¡µé¢ã€‚æ‰€æœ‰é¡µé¢ç¯å¢ƒéƒ½æ˜¯å¹¶è¡Œå¤„ç†çš„ã€‚

â€‹	ä½¿ç”¨å·¥ä½œè€…çº¿ç¨‹ï¼Œå¯ä»¥åœ¨åŸå§‹é¡µé¢ç¯å¢ƒä¹‹å¤–ï¼Œåœ¨åˆ†é…ä¸€ä¸ªå®Œå…¨ç‹¬ç«‹çš„äºŒçº§å­ç¯å¢ƒï¼Œä¸ä¸»çº¿ç¨‹ä¸èƒ½ç›´æ¥é€šä¿¡åªèƒ½ä½¿ç”¨ **æ¶ˆæ¯** å®Œæˆï¼Œ**ä¸èƒ½ä¸ä¾èµ–å•çº¿ç¨‹äº¤äº’çš„APIï¼ˆå¦‚DOMï¼‰äº’æ“ä½œ**ï¼Œä½†å¯ä»¥**ä¸çˆ¶ç¯å¢ƒå¹¶è¡Œæ‰§è¡Œ**ã€‚å·¥ä½œè€…çº¿ç¨‹ç›¸å¯¹è¾ƒé‡ï¼Œé€šå¸¸å ç”¨è¾ƒå¤§å†…å­˜ï¼Œä¸å»ºè®®å¤§é‡ä½¿ç”¨ï¼›è°ƒåº¦ä¹‹é—´å­˜åœ¨æ€§èƒ½æŸè€—ï¼Œæ‰€ä»¥åº”è¯¥è°¨æ…ä½¿ç”¨çº¿ç¨‹ï¼Œç»™å¸¸é©»çš„ã€å¯åŠ¨æˆæœ¬é«˜çš„ã€è®¡ç®—é‡è¾ƒå¤§çš„å·¥ä½œåˆ†é…ã€‚

â€‹	ğŸˆ	ä»¥å®é™…çº¿ç¨‹å®ç°çš„ï¼Œå¯¹åº”ç€åº•å±‚çš„çº¿ç¨‹ã€‚

â€‹	ğŸˆ	ç¯å¢ƒå†…çš„æŒ‡ä»¤æ˜¯å¯ä»¥å¹¶è¡Œæ‰§è¡Œçš„

â€‹	ğŸˆ	å¯ä»¥å…±äº«æŸäº›å†…å­˜ï¼Œä½†ä¸å®Œå…¨å…±äº«å…¨éƒ¨å†…å­˜ã€‚å¯ä»¥ä½¿ç”¨`sharedArrayBuffer`åœ¨å¤šä¸ªç¯å¢ƒé—´å…±äº«å†…å®¹ â€”â€” ä½¿ç”¨`Atomics`æ¥å£å®ç°å¹¶å‘æ§åˆ¶ï¼Œå…¶ä»–æ•°æ®è¿›å‡ºçº¿ç¨‹éœ€è¦ç§»åŠ¨æˆ–è€…å¤åˆ¶ã€‚

â€‹	ğŸˆ	å·¥ä½œè€…çº¿ç¨‹ä¸ä¸€å®šåœ¨åŒä¸€ä¸ªè¿›ç¨‹é‡Œï¼Œå…±äº«å·¥ä½œè€…çº¿ç¨‹å’ŒæœåŠ¡å·¥ä½œè€…çº¿ç¨‹å°±å¯èƒ½ä½¿ç”¨ç‹¬ç«‹çš„è¿›ç¨‹ã€‚

![å·¥ä½œè€…çº¿ç¨‹çš„ç»„æˆ.drawio](../assets/img/JavaScriptThread.assets/å·¥ä½œè€…çº¿ç¨‹çš„ç»„æˆ.drawio.png)

â€‹	**å­˜åœ¨é™åˆ¶ï¼š**

â€‹	ğŸš«	**å·¥ä½œè€…çº¿ç¨‹**ï¼ˆé¡¶çº§å·¥ä½œè€…çº¿ç¨‹å’Œå­å·¥ä½œè€…çº¿ç¨‹ï¼‰**çš„è„šæœ¬æ–‡ä»¶åªèƒ½ä»çˆ¶é¡µé¢ç›¸åŒçš„æºåŠ è½½ã€‚**å¯ä»¥åŠ è½½ã€æ‰§è¡Œå…¶ä»–éåŒæºçš„è„šæ­¥ï¼ˆ`importScript()`ï¼‰ã€‚

â€‹	ğŸš«	Worker çº¿ç¨‹å’Œä¸»çº¿ç¨‹ä¸åœ¨åŒä¸€ä¸ªä¸Šä¸‹æ–‡ç¯å¢ƒï¼Œå®ƒä»¬ä¸èƒ½ç›´æ¥é€šä¿¡ï¼Œå¿…é¡»é€šè¿‡æ¶ˆæ¯å®Œæˆã€‚

â€‹	ğŸš«	Worker çº¿ç¨‹æ— æ³•è¯»å–æœ¬åœ°æ–‡ä»¶ï¼Œå³ä¸èƒ½æ‰“å¼€æœ¬æœºçš„æ–‡ä»¶ç³»ç»Ÿï¼ˆ`file://`ï¼‰ã€‚

â€‹	ğŸš« 	æ— æ³•è¯»å–ã€æ“ä½œä¸»çº¿ç¨‹æ‰€åœ¨ç½‘é¡µçš„ DOM å¯¹è±¡ã€`window`å¯¹è±¡ç­‰

â€‹	**å­å·¥ä½œè€…çº¿ç¨‹**ï¼Œç¡®ä¿å¹¶è¡Œè®¡ç®—çš„æŠ•å…¥çš„æ”¶ç›Š > å¤šä¸ªå­çº¿ç¨‹è®¡ç®—æˆæœ¬ï¼›å­å·¥ä½œè€…çº¿ç¨‹çš„è„šæœ¬è·¯å¾„æ ¹æ®çˆ¶å·¥ä½œè€…çº¿ç¨‹è§£æã€‚

#### **æœ¬åœ°æ–‡ä»¶åˆå§‹åŒ–å·¥ä½œè€…çº¿ç¨‹**

â€‹	å·¥ä½œè€…çº¿ç¨‹éœ€è¦åŸºäºè„šæœ¬æ–‡ä»¶åˆ›å»ºï¼Œä½†ä¸æ„å‘³ç€è¯¥è„šæœ¬å¿…é¡»æ˜¯è¿œç¨‹èµ„æºã€‚å¯ä»¥åˆ©ç”¨`Blob`å¯¹è±¡çš„URLåœ¨è¡Œå†…åˆ›å»ºã€‚ **å¯ä»¥æ›´å¿«é€Ÿåˆå§‹åŒ–å·¥ä½œè€…çº¿ç¨‹ï¼Œæ²¡æœ‰ç½‘ç»œå»¶è¿Ÿã€‚**

â€‹	Blob å¯¹è±¡ï¼ŒäºŒè¿›åˆ¶ç±»å‹çš„å¤§æ–‡ä»¶ï¼Œæ˜¯ä¸å¯å˜ã€åŸå§‹æ•°æ®çš„ç±»æ–‡æœ¬å¯¹è±¡ï¼›å¯ä»¥ä»¥æ–‡æœ¬ã€äºŒè¿›åˆ¶æ ¼å¼è¯»å–ï¼Œæˆ–è½¬ä¸º`readable Stream`ã€‚

- `new Blob(array,{option})`ï¼š
  - arrayï¼Œå¯è¿­ä»£å¯¹è±¡ï¼ŒArrayã€DataViewã€Blobã€å­—ç¬¦ä¸²æˆ–ä»–ä»¬çš„æ··åˆï¼Œå°†è¢«æ”¾å…¥Blobä¸­
  - optionï¼ŒæŒ‡å®š`type`ï¼ˆæŒ‡å®šæ•°æ®çš„MIMEç±»å‹ï¼‰å’Œ`endings`ï¼ˆåŒ…å«ç»“æŸç¬¦`/n`å­—ç¬¦ä¸²å°†å¦‚ä½•è¢«å†™å…¥ï¼‰ä¸¤ä¸ªå±æ€§çš„å¯¹è±¡
    - `MIME`ï¼ˆå¤šç”¨é€”äº’è”ç½‘é‚®ä»¶æ‰©å±•ç±»å‹ `Multipurpose Internal Mail Extensions`)ï¼Œå¦‚`text/html` `image/png` `text/plain` `text/script`
    - `endings:transparent` é»˜è®¤å€¼ï¼Œä¿å­˜ä¸å˜
    - `endings:native` æ›´æ”¹ä¸ºæ›´é€‚åˆå®¿ä¸»ç³»ç»Ÿçš„æ¢è¡Œç¬¦ã€‚
- `URL.createObjectURL(object)` â€”â€” `URL.revokeObjectURL(objectURL)`
  - ä¼ å…¥ File / Blob / Medioa å¯¹è±¡ ç”¨ä»¥åˆ›å»º URL
  - ä½¿ç”¨`URL.createObjectURL(object)`åˆ›å»ºå¯¹è±¡URLï¼Œä»£è¡¨å¯¹è±¡å­˜åœ¨å¼•ç”¨ï¼Œä¼šå½±å“å†…å­˜åƒåœ¾å›æ”¶ï¼Œåº”è¯¥åœ¨åˆé€‚æ—¶æœºä½¿ç”¨`URL.revokeObjectURL(objectURL)` é‡Šæ”¾URLå¯¹è±¡
  - Web Workerä¸­å¯ä»¥ç”¨ï¼Œåœ¨Service Workerä¸­ä¸å¯ä»¥ç”¨ï¼Œå¯èƒ½å¯¼è‡´å†…å­˜æ³„æ¼ã€‚

```javascript
// å‡½æ•°ååºåˆ—åŒ–ä¼ å…¥ï¼Œåœ¨çˆ¶ä¸Šä¸‹æ–‡ä¸­å®šä¹‰ï¼Œåœ¨å­ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œ
function Fibonacci(n) {
    return n<1 ? 0 : n<2 ? 1 : Fibonacci(n-1) + Fibonacci(n-2)
}

// å­—ç¬¦ä¸²
const workerString = `
	self.onmessage = ({data}) => console.log(data);
	self.postMessage((${ Fibonacci.toString() })(9))
`
const workerBlob = new Blob([workerString],{type: 'text/javascript'})
const workerBlobURL = URL.createObjectURL(workerBlob);
const worker = new Worker(workerBlobURL)
worker.onmessage = ({data}) => console.log(data) // 34 æ¥æ”¶workerå›ä¼ æ•°æ®
worker.postMessage('hi,just say something?'); // hi,just say something? å‘workerå‘ç”Ÿæ•°æ®

// ç¼©å†™ï¼š
const worker = new Worker(URL.createObjectURL(new Blob([workerString])));
```

#### åœ¨å·¥ä½œè€…çº¿ç¨‹ä¸­åŠ¨æ€æ‰§è¡Œè„šæœ¬

â€‹	ä½¿ç”¨`importScripts()` æ–¹æ³•ç¼–ç¨‹æ–¹å¼ï¼Œ<u>ä¸ä¸€å®šæŒ‰é¡ºåº</u>åŠ è½½ã€<u>æŒ‰é¡ºåºåŒæ­¥</u>æ‰§è¡Œä»»æ„è„šæœ¬ï¼Œå¯ä»¥æ¥æ”¶<u>ä»»æ„æ•°é‡çš„å‚æ•°</u>

- æ— è®ºæ˜¯ä»€ä¹ˆç±»å‹æ–‡ä»¶ï¼Œéƒ½ä¼šå½“æˆJavaScriptè§£æï¼Œæ‰€ä»¥éœ€è¦æ˜¯æœ‰æ•ˆçš„ JavaScript MIME ç±»å‹ï¼Œå¦‚`text/javascript`
- åœ¨å·¥ä½œè€…çº¿ç¨‹å†…éƒ¨å¯ä»¥è¯·æ±‚ä»»ä½•æ¥æºçš„è„šæœ¬ï¼ˆæ²¡æœ‰`CORS`é™åˆ¶ï¼‰
- åŠ è½½æˆåŠŸåï¼Œæ¯ä¸ªè„šæœ¬ä¸­çš„å…¨å±€ä¸Šä¸‹æ–‡éƒ½èƒ½å¤Ÿåœ¨ Worker çº¿ç¨‹ä¸­ä½¿ç”¨ â€”â€” å…±äº«ä½œç”¨åŸŸ
- å¦‚æœè„šæœ¬æ— æ³•åŠ è½½ï¼Œå°†ä¼šæŠ›å‡ºé”™è¯¯ï¼Œå¹¶ä¸”ä¹‹åçš„ä»£ç ä¹Ÿæ— æ³•æ‰§è¡Œäº†

```javascript
// main.js
const worker = new Worker('./worker.js',{name:'foo'});

// worker.js
importScripts('./scriptA.js','./scriptB.js');
const workerToken = 'worker.js'
console.log(`in worker.js,, name is ${ self.name }, workerToken is ${ workerToken }`)

// scriptA.js
console.log(`in scriptA.js, name is ${ self.name }, workerToken is ${ workerToken }`)
// scriptB.js
console.log(`in scriptB.js, name is ${ self.name }, workerToken is ${ workerToken }`)
```

#### å¤„ç†å·¥ä½œè€…çº¿ç¨‹é”™è¯¯

â€‹	æŠ›å‡ºé”™è¯¯çš„å·¥ä½œè€…çº¿ç¨‹ï¼Œå¯ä»¥ä¸æ‰“æ–­çˆ¶çº¿ç¨‹çš„æ‰§è¡Œã€‚`try/catch`ä¸èƒ½æ•è·åˆ°é”™è¯¯ï¼Œä¸è¿‡ä¾ç„¶ä¼šå†’æ³¡åˆ°å·¥ä½œè€…çº¿ç¨‹çš„å…¨å±€ä¸Šä¸‹æ–‡ï¼Œå› æ­¤å¯ä»¥åœ¨Workerå¯¹è±¡ä¸Šè®¾ç½® **é”™è¯¯äº‹ä»¶ç›‘å¬å™¨** æ‰å¯ä»¥è®¿é—®åˆ°ã€‚

```javascript
// main.js 
const worker = new Worker('./woker.js')
worker.onerror = console.log; // isTrusted: true, message: 'Uncaught Error: errormessage',....

// woker.js
throw Error('errormessage')
```